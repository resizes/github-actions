name: "TruffleHog Scan"
description: "Run TruffleHog secret scanner and add results to summary"
runs:
  using: "composite"
  steps:
    - name: Run TruffleHog Scan
      run: |
        # Scanning GitHub Repo where action is run and looking for verified keys (no false positives)
        # TruffleHog will show error code 183 whenever a potential secret is found
        docker run --rm -v "$PWD":/tmp -w /tmp ghcr.io/trufflesecurity/trufflehog:latest \
        git file:///tmp \
        --results=verified,unknown \
        --json > trufflehog.json || true  

      shell: bash
        
      
    - name: Process Results
      run: |
        echo "## �� TruffleHog Report" >> $GITHUB_STEP_SUMMARY
        
        if [ -f trufflehog.json ]; then
          # Count verified secrets found
          secrets=$(jq -s '[.[] | select(.detector_name != null)] | length' trufflehog.json || echo "0")
          
          if [ "$secrets" -gt 0 ]; then
            echo "🚨 **$secrets verified secrets found!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Detected Secrets:" >> $GITHUB_STEP_SUMMARY
            
            # Extract and display secret details
            jq -r '.[] | "- **\(.source_type):** \(.source_name) - \(.detector_name)"' trufflehog.json >> $GITHUB_STEP_SUMMARY
          else
            echo "✅ No verified secrets found" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "⚠️ Scan completed but no results file found" >> $GITHUB_STEP_SUMMARY
        fi
      shell: bash
